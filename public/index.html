<!DOCTYPE html>
<html dir="rtl" lang="fa">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>سامانه رصد زلزله‌های ایران</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-earth-asia"></i> سامانه رصد زلزله‌های ایران</h1>
            
            <div class="refresh-container">
                <div class="last-updated">
                    <span id="update-time">--:--</span>
                    <small id="update-date"></small>
                </div>
                <button id="refresh-btn" onclick="fetchEarthquakes()">
                    <span id="refresh-text"><i class="fas fa-sync-alt"></i> بروزرسانی</span>
                    <span id="refresh-spinner" style="display:none;">
                        <i class="fas fa-spinner fa-spin"></i> در حال بروزرسانی...
                    </span>
                </button>
            </div>
        </header>

        <div class="earthquake-info">
            <div class="stats">
                <div class="stat-box">
                    <span class="stat-title">تعداد زلزله‌ها:</span>
                    <span class="stat-value" id="quake-count">0</span>
                </div>
                <div class="stat-box">
                    <span class="stat-title">قوی‌ترین زلزله:</span>
                    <span class="stat-value" id="strongest-quake">0</span>
                </div>
            </div>
        </div>

        <div class="table-container">
            <table id="earthquake-table">
                <thead>
                    <tr>
                        <th>تاریخ</th>
                        <th>زمان</th>
                        <th>مختصات</th>
                        <th>عمق (km)</th>
                        <th>بزرگی</th>
                        <th>محل وقوع</th>
                    </tr>
                </thead>
                <tbody id="table-body">
                    <!-- داده‌ها اینجا نمایش داده می‌شوند -->
                </tbody>
            </table>
        </div>

        <footer>
            <p>منبع داده‌ها: <a href="http://irsc.ut.ac.ir" target="_blank">مرکز لرزه‌نگاری ایران</a></p>
            <p class="version">نسخه 1.1.0</p>
        </footer>
    </div>

    <script>
        // تابع تبدیل تاریخ به فرمت فارسی
        function toPersianDigits(number) {
            const persianDigits = ['۰', '۱', '۲', '۳', '۴', '۵', '۶', '۷', '۸', '۹'];
            return number.toString().replace(/\d/g, d => persianDigits[d]);
        }

        // تابع نمایش زلزله‌ها
        function displayEarthquakes(earthquakes) {
            const tableBody = document.getElementById('table-body');
            tableBody.innerHTML = '';
            
            if (!earthquakes || earthquakes.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = '<td colspan="6" class="no-data">داده‌ای یافت نشد</td>';
                tableBody.appendChild(row);
                return;
            }
            
            // آپدیت آمار
            document.getElementById('quake-count').textContent = toPersianDigits(earthquakes.length);
            
            const strongest = Math.max(...earthquakes.map(q => q.magnitude));
            document.getElementById('strongest-quake').textContent = toPersianDigits(strongest.toFixed(1));
            
            // نمایش هر زلزله در جدول
            earthquakes.forEach(quake => {
                const row = document.createElement('tr');
                
                // رنگ‌بندی بر اساس بزرگی
                let magnitudeClass = '';
                if (quake.magnitude >= 5) magnitudeClass = 'high-magnitude';
                else if (quake.magnitude >= 4) magnitudeClass = 'medium-magnitude';
                
                row.innerHTML = `
                    <td>${quake.date}</td>
                    <td>${quake.time}</td>
                    <td>${toPersianDigits(quake.latitude.toFixed(2))}, ${toPersianDigits(quake.longitude.toFixed(2))}</td>
                    <td>${toPersianDigits(quake.depth.toFixed(1))}</td>
                    <td class="${magnitudeClass}">${toPersianDigits(quake.magnitude.toFixed(1))}</td>
                    <td>${quake.location}</td>
                `;
                
                tableBody.appendChild(row);
            });
        }

        // تابع دریافت داده‌های زلزله
        async function fetchEarthquakes() {
            const btn = document.getElementById('refresh-btn');
            const spinner = document.getElementById('refresh-spinner');
            const text = document.getElementById('refresh-text');
            
            btn.disabled = true;
            text.style.display = 'none';
            spinner.style.display = 'inline';
            
            try {
                const timestamp = new Date().getTime();
                const response = await fetch(`/api/data?_=${timestamp}`);
                
                if (!response.ok) {
                    throw new Error('خطا در دریافت داده‌ها');
                }
                
                const data = await response.json();
                
                if (!data.success) {
                    throw new Error(data.error || 'خطای ناشناخته');
                }
                
                // نمایش زمان بروزرسانی
                const now = new Date();
                document.getElementById('update-time').textContent = now.toLocaleTimeString('fa-IR');
                document.getElementById('update-date').textContent = now.toLocaleDateString('fa-IR');
                
                // نمایش داده‌ها
                displayEarthquakes(data.data);
                
            } catch (error) {
                console.error('Error:', error);
                alert('خطا در بروزرسانی داده‌ها: ' + error.message);
            } finally {
                btn.disabled = false;
                spinner.style.display = 'none';
                text.style.display = 'inline';
            }
        }

        // بارگذاری اولیه داده‌ها
        document.addEventListener('DOMContentLoaded', () => {
            fetchEarthquakes();
            
            // نمایش زمان فعلی
            const now = new Date();
            document.getElementById('update-time').textContent = now.toLocaleTimeString('fa-IR');
            document.getElementById('update-date').textContent = now.toLocaleDateString('fa-IR');
        });
    </script>
</body>
</html>
